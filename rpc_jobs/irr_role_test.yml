- job-template:
    # DEFAULTS
    STAGES: >
      Allocate Resources,
      Connect Slave,
      Prepare Deployment,
      Run IRR Tests,
      Cleanup,
      Destroy Slave
    NUM_TO_KEEP: 30
    # Flavor name
    irr_flavor: "general1-8"
    # Note: branches is the branch pattern to match for PR Jobs.
    branches: master
    # TEMPLATE
    name: 'RPC-IRR_{repo}-{series}-{image}-{context}'
    project-type: workflow
    concurrent: true
    properties:
      - build-discarder:
          num-to-keep: "{NUM_TO_KEEP}"
      - github:
          url: "{irr_repo_url}"
    parameters:
      - rpc_gating_params
      - instance_params:
          IMAGE: "{IMAGE}"
          FLAVOR: "{irr_flavor}"
          REGIONS: "{REGIONS}"
          FALLBACK_REGIONS: "{FALLBACK_REGIONS}"
      - string:
          name: IRR_CONTEXT
          default: "{context}"
      - string:
          name: IRR_IMAGE
          default: "{image}"
      - string:
          name: IRR_SERIES
          default: "{series}"
      - string:
          name: STAGES
          default: "{STAGES}"
          description: |
            Pipeline stages to run CSV. Note that this list does not influence execution order.
            Options:
              Allocate Resources
              Connect Slave
              Prepare Deployment
              Run IRR Tests
              Cleanup
              Destroy Slave
    triggers:
      - github-pull-request:
          org-list:
            - rcbops
          github-hooks: true
          trigger-phrase: '.*recheck_cit_all.*|.*recheck_cit_{image}_{context}.*'
          only-trigger-phrase: false
          white-list-target-branches:
            - "{branches}"
          auth-id: "github_account_rpc_jenkins_svc"
          status-context: 'CIT/{image}_{context}'
          cancel-builds-on-update: true

    dsl: |
      library "rpc-gating@${{RPC_GATING_BRANCH}}"
      common.globalWraps(){{
        timeout(time: 5, unit: 'HOURS'){{
          irr_role_tests.run_irr_tests()
        }} // timeout
      }} // globalWraps
